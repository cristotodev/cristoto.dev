---
import { Icon } from "astro-icon/components";
---

<div class="block bg-color-100 rounded-lg p-4 my-6 overflow-hidden" id="newsletter-hero">
	<div class="max-w-md mx-auto text-center px-2">
		<div class="mb-4">
			<h3 class="text-lg font-semibold text-textColor mb-2">
				📧 ¡Únete a mi newsletter!
			</h3>
			<p class="text-light text-sm">
				Contenido técnico exclusivo directo a tu bandeja de entrada.
			</p>
		</div>

		<form id="newsletter-hero-form" class="space-y-3">
			<div class="flex flex-col sm:flex-row gap-2">
				<input
					type="email"
					id="hero-email"
					name="email"
					required
					placeholder="tu.email@ejemplo.com"
					class="flex-1 px-3 py-2 bg-bgColor border border-color-400 rounded-lg text-textColor placeholder-light focus:outline-none focus:ring-2 focus:ring-accent-two focus:border-transparent transition-colors text-sm min-w-0 w-full sm:w-auto"
				/>
				<button
					type="submit"
					class="bg-accent-base hover:bg-accent-two text-bgColor font-medium py-2 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center gap-1 disabled:opacity-50 disabled:cursor-not-allowed text-sm whitespace-nowrap flex-shrink-0 w-full sm:w-auto"
				>
					<span id="hero-submit-text">Suscribir</span>
					<Icon 
						id="hero-submit-icon" 
						class="h-4 w-4" 
						name="hugeicons:arrow-right-02" 
						aria-hidden="true"
					/>
				</button>
			</div>

			<label class="flex items-start gap-2 text-xs cursor-pointer">
				<input
					type="checkbox"
					id="hero-terms"
					name="terms"
					required
					class="mt-0.5 h-3 w-3 appearance-none bg-bgColor border border-color-400 rounded cursor-pointer flex-shrink-0 checked:bg-accent-two checked:border-accent-two focus:outline focus:outline-1 focus:outline-accent-two focus:outline-offset-1 relative checked:after:content-[''] checked:after:absolute checked:after:left-1/2 checked:after:top-1/2 checked:after:-translate-x-1/2 checked:after:-translate-y-1/2 checked:after:rotate-45 checked:after:w-1 checked:after:h-1.5 checked:after:border-solid checked:after:border-bgColor checked:after:border-r checked:after:border-b"
				/>
				<span class="text-light leading-4">
					Acepto la 
					<a href="/privacy/" class="text-accent-two hover:underline">política de privacidad</a> 
					y el tratamiento de datos.
				</span>
			</label>
		</form>

		<div id="hero-form-message" class="mt-3 text-xs text-center hidden">
			<div id="hero-success-message" class="text-green-600 hidden">
				<Icon class="h-4 w-4 inline mr-1" name="hugeicons:checkmark-circle-02" />
				¡Email de confirmación enviado! Revisa tu bandeja de entrada.
			</div>
			<div id="hero-error-message" class="text-red-600 hidden">
				<Icon class="h-4 w-4 inline mr-1" name="hugeicons:alert-circle" />
				<span id="hero-error-text">Ha ocurrido un error. Inténtalo de nuevo.</span>
			</div>
		</div>
	</div>
</div>

<script>
	class NewsletterHero {
		private form: HTMLFormElement;
		private emailInput: HTMLInputElement;
		private termsInput: HTMLInputElement;
		private submitButton: HTMLButtonElement;
		private submitText: HTMLSpanElement;
		private submitIcon: HTMLElement;
		private formMessage: HTMLDivElement;
		private successMessage: HTMLDivElement;
		private errorMessage: HTMLDivElement;
		private errorText: HTMLSpanElement;

		constructor() {
			const container = document.getElementById('newsletter-hero')!;
			
			this.form = container.querySelector('#newsletter-hero-form')!;
			this.emailInput = container.querySelector('#hero-email')!;
			this.termsInput = container.querySelector('#hero-terms')!;
			this.submitButton = container.querySelector('button[type="submit"]')!;
			this.submitText = container.querySelector('#hero-submit-text')!;
			this.submitIcon = container.querySelector('#hero-submit-icon')!;
			this.formMessage = container.querySelector('#hero-form-message')!;
			this.successMessage = container.querySelector('#hero-success-message')!;
			this.errorMessage = container.querySelector('#hero-error-message')!;
			this.errorText = container.querySelector('#hero-error-text')!;

			this.form.addEventListener('submit', this.handleSubmit.bind(this));
		}

		private async handleSubmit(event: Event) {
			event.preventDefault();

			if (!this.validateForm()) {
				return;
			}

			this.setLoadingState(true);
			this.hideMessages();

			try {
				const formData = new FormData(this.form);
				const email = formData.get('email') as string;

				const response = await fetch('/api/newsletter/subscribe', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify({ email }),
				});

				const result = await response.json();

				if (response.ok && result.success) {
					this.showSuccess();
					this.form.reset();
				} else {
					this.showError(result.error || 'Ha ocurrido un error inesperado.');
				}
			} catch (error) {
				this.showError('Error de conexión. Verifica tu internet.');
			} finally {
				this.setLoadingState(false);
			}
		}

		private validateForm(): boolean {
			const email = this.emailInput.value.trim();
			const termsAccepted = this.termsInput.checked;

			if (!email) {
				this.showError('Ingresa tu correo electrónico.');
				this.emailInput.focus();
				return false;
			}

			if (!this.isValidEmail(email)) {
				this.showError('Ingresa un correo electrónico válido.');
				this.emailInput.focus();
				return false;
			}

			if (!termsAccepted) {
				this.showError('Acepta la política de privacidad.');
				this.termsInput.focus();
				return false;
			}

			return true;
		}

		private isValidEmail(email: string): boolean {
			const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
			return emailRegex.test(email);
		}

		private setLoadingState(loading: boolean) {
			this.submitButton.disabled = loading;
			
			if (loading) {
				this.submitText.textContent = 'Enviando...';
				this.submitIcon.style.display = 'none';
			} else {
				this.submitText.textContent = 'Suscribir';
				this.submitIcon.style.display = 'inline';
			}
		}

		private showSuccess() {
			this.formMessage.classList.remove('hidden');
			this.successMessage.classList.remove('hidden');
			this.errorMessage.classList.add('hidden');
		}

		private showError(message: string) {
			this.errorText.textContent = message;
			this.formMessage.classList.remove('hidden');
			this.errorMessage.classList.remove('hidden');
			this.successMessage.classList.add('hidden');
		}

		private hideMessages() {
			this.formMessage.classList.add('hidden');
			this.successMessage.classList.add('hidden');
			this.errorMessage.classList.add('hidden');
		}
	}

	document.addEventListener('DOMContentLoaded', () => {
		new NewsletterHero();
	});
</script>