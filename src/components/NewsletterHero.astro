---
import { Icon } from "astro-icon/components";
---

<newsletter-hero class="bg-color-100 rounded-lg p-4 my-6">
	<div class="max-w-md mx-auto text-center">
		<div class="mb-4">
			<h3 class="text-lg font-semibold text-textColor mb-2">
				üìß ¬°√önete a mi newsletter!
			</h3>
			<p class="text-light text-sm">
				Contenido t√©cnico exclusivo directo a tu bandeja de entrada.
			</p>
		</div>

		<form id="newsletter-hero-form" class="space-y-3">
			<div class="flex gap-2">
				<input
					type="email"
					id="hero-email"
					name="email"
					required
					placeholder="tu.email@ejemplo.com"
					class="flex-1 px-3 py-2 bg-bgColor border border-color-400 rounded-lg text-textColor placeholder-light focus:outline-none focus:ring-2 focus:ring-accent-two focus:border-transparent transition-colors text-sm"
				/>
				<button
					type="submit"
					class="bg-accent-base hover:bg-accent-two text-bgColor font-medium py-2 px-4 rounded-lg transition-colors duration-200 flex items-center gap-1 disabled:opacity-50 disabled:cursor-not-allowed text-sm whitespace-nowrap"
				>
					<span id="hero-submit-text">Suscribir</span>
					<Icon 
						id="hero-submit-icon" 
						class="h-4 w-4" 
						name="hugeicons:arrow-right-02" 
						aria-hidden="true"
					/>
				</button>
			</div>

			<label class="flex items-start gap-2 text-xs cursor-pointer">
				<input
					type="checkbox"
					id="hero-terms"
					name="terms"
					required
					class="mt-0.5 h-3 w-3 text-accent-two border-color-400 rounded focus:ring-accent-two focus:ring-1"
				/>
				<span class="text-light leading-4">
					Acepto la 
					<a href="/privacy/" class="text-accent-two hover:underline">pol√≠tica de privacidad</a> 
					y el tratamiento de datos.
				</span>
			</label>
		</form>

		<div id="hero-form-message" class="mt-3 text-xs text-center hidden">
			<div id="hero-success-message" class="text-green-600 hidden">
				<Icon class="h-4 w-4 inline mr-1" name="hugeicons:checkmark-circle-02" />
				¬°Email de confirmaci√≥n enviado! Revisa tu bandeja de entrada.
			</div>
			<div id="hero-error-message" class="text-red-600 hidden">
				<Icon class="h-4 w-4 inline mr-1" name="hugeicons:alert-circle" />
				<span id="hero-error-text">Ha ocurrido un error. Int√©ntalo de nuevo.</span>
			</div>
		</div>
	</div>
</newsletter-hero>

<script>
	class NewsletterHero extends HTMLElement {
		private form: HTMLFormElement;
		private emailInput: HTMLInputElement;
		private termsInput: HTMLInputElement;
		private submitButton: HTMLButtonElement;
		private submitText: HTMLSpanElement;
		private submitIcon: HTMLElement;
		private formMessage: HTMLDivElement;
		private successMessage: HTMLDivElement;
		private errorMessage: HTMLDivElement;
		private errorText: HTMLSpanElement;

		constructor() {
			super();
			
			this.form = this.querySelector('#newsletter-hero-form')!;
			this.emailInput = this.querySelector('#hero-email')!;
			this.termsInput = this.querySelector('#hero-terms')!;
			this.submitButton = this.querySelector('button[type="submit"]')!;
			this.submitText = this.querySelector('#hero-submit-text')!;
			this.submitIcon = this.querySelector('#hero-submit-icon')!;
			this.formMessage = this.querySelector('#hero-form-message')!;
			this.successMessage = this.querySelector('#hero-success-message')!;
			this.errorMessage = this.querySelector('#hero-error-message')!;
			this.errorText = this.querySelector('#hero-error-text')!;

			this.form.addEventListener('submit', this.handleSubmit.bind(this));
		}

		private async handleSubmit(event: Event) {
			event.preventDefault();

			if (!this.validateForm()) {
				return;
			}

			this.setLoadingState(true);
			this.hideMessages();

			try {
				const formData = new FormData(this.form);
				const email = formData.get('email') as string;

				const response = await fetch('/api/newsletter/subscribe', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify({ email }),
				});

				const result = await response.json();

				if (response.ok && result.success) {
					this.showSuccess();
					this.form.reset();
				} else {
					this.showError(result.error || 'Ha ocurrido un error inesperado.');
				}
			} catch (error) {
				this.showError('Error de conexi√≥n. Verifica tu internet.');
			} finally {
				this.setLoadingState(false);
			}
		}

		private validateForm(): boolean {
			const email = this.emailInput.value.trim();
			const termsAccepted = this.termsInput.checked;

			if (!email) {
				this.showError('Ingresa tu correo electr√≥nico.');
				this.emailInput.focus();
				return false;
			}

			if (!this.isValidEmail(email)) {
				this.showError('Ingresa un correo electr√≥nico v√°lido.');
				this.emailInput.focus();
				return false;
			}

			if (!termsAccepted) {
				this.showError('Acepta la pol√≠tica de privacidad.');
				this.termsInput.focus();
				return false;
			}

			return true;
		}

		private isValidEmail(email: string): boolean {
			const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
			return emailRegex.test(email);
		}

		private setLoadingState(loading: boolean) {
			this.submitButton.disabled = loading;
			
			if (loading) {
				this.submitText.textContent = 'Enviando...';
				this.submitIcon.style.display = 'none';
			} else {
				this.submitText.textContent = 'Suscribir';
				this.submitIcon.style.display = 'inline';
			}
		}

		private showSuccess() {
			this.formMessage.classList.remove('hidden');
			this.successMessage.classList.remove('hidden');
			this.errorMessage.classList.add('hidden');
		}

		private showError(message: string) {
			this.errorText.textContent = message;
			this.formMessage.classList.remove('hidden');
			this.errorMessage.classList.remove('hidden');
			this.successMessage.classList.add('hidden');
		}

		private hideMessages() {
			this.formMessage.classList.add('hidden');
			this.successMessage.classList.add('hidden');
			this.errorMessage.classList.add('hidden');
		}
	}

	customElements.define('newsletter-hero', NewsletterHero);
</script>

<style>
	newsletter-hero {
		display: block;
	}

	/* Custom checkbox styling to match the theme - smaller for hero */
	input[type="checkbox"] {
		appearance: none;
		background-color: theme('colors.bgColor');
		border: 1px solid theme('colors.color.400');
		border-radius: 0.25rem;
		width: 0.75rem;
		height: 0.75rem;
		position: relative;
		cursor: pointer;
		flex-shrink: 0;
	}

	input[type="checkbox"]:checked {
		background-color: theme('colors.accent-two');
		border-color: theme('colors.accent-two');
	}

	input[type="checkbox"]:checked::after {
		content: '';
		position: absolute;
		left: 50%;
		top: 50%;
		transform: translate(-50%, -50%) rotate(45deg);
		width: 0.25rem;
		height: 0.375rem;
		border: solid theme('colors.bgColor');
		border-width: 0 1px 1px 0;
	}

	input[type="checkbox"]:focus {
		outline: 1px solid theme('colors.accent-two');
		outline-offset: 1px;
	}
</style>