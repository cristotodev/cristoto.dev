---
import { type CollectionEntry } from "astro:content";
import { getAllPosts } from "@/data/post";
import { findRelatedPosts } from "@/utils/internal-linking";
import { Icon } from "astro-icon/components";

interface Props {
	currentPost: CollectionEntry<"post">;
	maxResults?: number;
	showDescription?: boolean;
}

const { currentPost, maxResults = 3, showDescription = true } = Astro.props;

const allPosts = await getAllPosts();
const relatedPosts = findRelatedPosts(
	{
		id: currentPost.id,
		title: currentPost.data.title,
		tags: currentPost.data.tags || [],
		description: currentPost.data.description
	},
	allPosts,
	maxResults
);

// Generate schema markup for related posts
const relatedPostsSchema = relatedPosts.length > 0 ? {
	"@context": "https://schema.org",
	"@type": "ItemList",
	"name": "Posts Relacionados",
	"description": `Artículos relacionados con ${currentPost.data.title}`,
	"numberOfItems": relatedPosts.length,
	"itemListElement": relatedPosts.map((post, index) => ({
		"@type": "ListItem",
		"position": index + 1,
		"item": {
			"@type": "Article",
			"name": post.title,
			"url": `https://cristoto.dev${post.url}`,
			"description": post.description
		}
	}))
} : null;
---

{relatedPosts.length > 0 && (
	<>
		{relatedPostsSchema && (
			<script type="application/ld+json" set:html={JSON.stringify(relatedPostsSchema, null, 0)} />
		)}
		
		<section class="related-posts mt-12 p-6 bg-special-lighter rounded-lg border border-accent-base/10">
			<div class="flex items-center mb-6">
				<Icon class="w-6 h-6 mr-3 text-accent-base" name="solar:notes-line-duotone" />
				<h2 class="text-xl font-semibold text-textColor">Posts Relacionados</h2>
			</div>
			
			<div class="grid gap-4 md:grid-cols-1 lg:grid-cols-1">
				{relatedPosts.map((post, index) => (
					<article class="related-post group">
						<a 
							href={post.url}
							class="block p-4 rounded-lg bg-white dark:bg-gray-800 hover:bg-accent-base/5 dark:hover:bg-accent-base/10 transition-colors border border-special-light hover:border-accent-base/20"
						>
							<div class="flex items-start justify-between">
								<div class="flex-grow">
									<h3 class="font-medium text-accent-base group-hover:text-accent-base/80 mb-2 leading-snug">
										{post.title}
									</h3>
									
									{showDescription && post.description && (
										<p class="text-sm text-textColor/70 mb-3 line-clamp-2">
											{post.description.length > 100 
												? `${post.description.substring(0, 100)}...` 
												: post.description
											}
										</p>
									)}
									
									<div class="flex items-center justify-between">
										<div class="flex flex-wrap gap-2">
											{post.tags.slice(0, 3).map(tag => (
												<span class="inline-block px-2 py-1 text-xs bg-accent-base/10 text-accent-base rounded">
													{tag}
												</span>
											))}
										</div>
										
										<div class="flex items-center text-xs text-textColor/60">
											<span class="mr-1">Relevancia:</span>
											<div class="flex">
												{Array.from({ length: 5 }, (_, i) => (
													<Icon 
														class={`w-3 h-3 ${i < Math.round(post.relevanceScore * 5) ? 'text-accent-base' : 'text-textColor/20'}`}
														name="solar:star-bold"
													/>
												))}
											</div>
										</div>
									</div>
								</div>
								
								<Icon 
									class="w-5 h-5 text-textColor/40 group-hover:text-accent-base transform group-hover:translate-x-1 transition-all ml-4 flex-shrink-0 mt-1"
									name="solar:arrow-right-line-duotone"
								/>
							</div>
						</a>
					</article>
				))}
			</div>
			
			<!-- Call to action for more posts -->
			<div class="mt-6 pt-4 border-t border-accent-base/10 text-center">
				<a 
					href="/posts/"
					class="inline-flex items-center text-accent-base hover:text-accent-base/80 font-medium"
				>
					<Icon class="w-4 h-4 mr-2" name="solar:notes-bold" />
					Ver todos los posts
					<Icon class="w-4 h-4 ml-2" name="solar:arrow-right-line-duotone" />
				</a>
			</div>
		</section>
	</>
)}

<!-- Fallback when no related posts found -->
{relatedPosts.length === 0 && (
	<section class="related-posts mt-12 p-6 bg-special-lighter rounded-lg border border-accent-base/10 text-center">
		<Icon class="w-12 h-12 mx-auto mb-4 text-textColor/40" name="solar:notes-line-duotone" />
		<h3 class="text-lg font-medium text-textColor mb-2">Explora más contenido</h3>
		<p class="text-textColor/70 mb-4">
			¿Te ha gustado este post? Descubre más tutoriales y guías en el blog.
		</p>
		<a 
			href="/posts/"
			class="inline-flex items-center bg-accent-base text-white px-6 py-3 rounded-lg hover:bg-accent-base/90 transition-colors"
		>
			<Icon class="w-4 h-4 mr-2" name="solar:notes-bold" />
			Ver todos los posts
		</a>
	</section>
)}

<style>
	.related-post {
		position: relative;
	}
	
	.related-post::before {
		content: '';
		position: absolute;
		left: 0;
		top: 0;
		width: 3px;
		height: 0;
		background: var(--accent-base);
		transition: height 0.3s ease;
	}
	
	.related-post:hover::before {
		height: 100%;
	}
	
	.line-clamp-2 {
		display: -webkit-box;
		-webkit-line-clamp: 2;
		-webkit-box-orient: vertical;
		overflow: hidden;
	}
</style>